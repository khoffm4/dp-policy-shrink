---
title: "Regression Analysis"
author: "Ryan Steed"
date: "9/9/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r deps}
source("R/utils.R")
```

```{r load-baseline}
# raw = read.csv("results/discrimination.csv")
raw = fread("results/baseline_eps=0.1.csv")
```

```{r clean}
# use short df
# df = raw %>% filter(trial < 10)
df = clean(raw)
nrow(df)
```

## Costs & benefits across groups
```{r average_across_trials}
grouped = df %>%
  mutate(treatment = "baseline") %>%
  summarise_trials
```

```{r results}
# misalloc per non-white student
ggplot(grouped, aes(x=prop_white)) +
  geom_point(aes(y=misalloc_sampling_per_child, color="Sampling"), alpha=0.5) +
  geom_point(aes(y=misalloc_dp_sampling_per_child, color="DP + Sampling"), alpha=0.5)
# average misalloc per student
ggplot(grouped) +
  geom_histogram(aes(x=misalloc_sampling_per_child, fill="Sampling"), bins=100, alpha=0.5) +
  geom_histogram(aes(x=misalloc_dp_sampling_per_child, fill="DP + Sampling"), bins=100, alpha=0.5)
# average misalloc per eligible student
ggplot(grouped) +
  geom_histogram(aes(x=misalloc_sampling / true_children_eligible, fill="Sampling"), bins=100, alpha=0.5) +
  geom_histogram(aes(x=misalloc_dp_sampling / true_children_eligible, fill="DP + Sampling"), bins=100, alpha=0.5)
```

```{r race}
# kind = "hispanic"
kind = "race_aggregate"
# kind = "race"
# kind = "intersectional"

sorted = race_comparison(grouped, kind)
```

```{r race-plots}
# hist = comparison_all %>%
#   dplyr::select(
#     children_of_race, 
#     race, 
#     misalloc_dp_per_child, 
#     dp_benefit_per_child,
#     misalloc_sampling_per_child, 
#     sampling_benefit_per_child,
#     misalloc_dp_sampling_per_child, 
#     dp_sampling_benefit_per_child
#   ) %>%
#   uncount(children_of_race)
# 
# plot = list(
#   ggtitle("Misallocation by Race"),
#   ylab("# children")
# )

# ggplot(
#   hist,
#   aes(x=cuberoot(misalloc_dp_per_child))
# ) + geom_vline(mapping=aes(xintercept=cuberoot(dp_benefit_per_child)), data=comparison_mean, color="red") +
#   geom_histogram(bins=100) +
#   facet_wrap(~race, ncol=3, scales="free_y") +
#   xlab("Misallocation per child (DP minus no DP, no sampling)")
# ggplot(
#   hist,
#   aes(x=cuberoot(misalloc_sampling_per_child))
# ) + geom_vline(mapping=aes(xintercept=cuberoot(sampling_benefit_per_child)), data=comparison_mean, color="red") +
#   xlab("Misallocation per child (Sampling minus true)")
# ggplot(
#   hist,
#   aes(x=cuberoot(misalloc_dp_sampling_per_child))
# ) + geom_vline(mapping=aes(xintercept=cuberoot(dp_sampling_benefit_per_child)), data=comparison_mean, color="red") +
#   xlab("Misallocation per child (DP + sampling minus true)")

# plot = list(
#   geom_boxplot(notch=TRUE),
#   coord_flip(),
#   ggtitle("Misallocation by Race"),
#   xlab("Census Race Category")
# )
# ggplot(hist, aes(x=reorder(race, dp_benefit_per_child), y=cuberoot(misalloc_dp_per_child))) +
#   plot +
#   ylab("Misallocation (DP minus true) per child (cube root)")
# ggplot(hist, aes(x=reorder(race, sampling_benefit_per_child), y=cuberoot(misalloc_sampling_per_child))) +
#   plot +
#   ylab("Misallocation (sampling minus true) per child (cube root)")
# ggplot(hist, aes(x=reorder(race, dp_sampling_benefit_per_child), y=cuberoot(misalloc_dp_sampling_per_child))) +
#   plot +
#   ylab("Misallocation (DP + sampling minus true) per child (cube root)")


# stacked_bar = comparison_all %>%
#   pivot_longer(c(sampling_benefit_per_child_eligible, dp_sampling_benefit_per_child_eligible), names_to="noise_added", values_to="benefit_per_child_eligible")
# 
# ggplot(stacked_bar, aes(x=reorder(race, benefit_per_child_eligible), y=benefit_per_child_eligible, fill=noise_added)) +
#   geom_bar(stat="identity", position="dodge") +
#   coord_flip() +
#   ylab("Race-weighted misallocation per eligible child")


plot = list(
  geom_col(aes(fill=""), color="black"),
  coord_flip(),
  # ggtitle("Race-weighted misallocation"),
  xlab("Census Race Category")
)

# ggplot(comparison_all, aes(x=reorder(race, dp_benefit_per_child_eligible), y=dp_benefit_per_child_eligible)) +
#   plot +
#   ylab("Race-weighted misallocation per eligible child (DP minus true)")
# ggsave("plots/misalloc_race_dp.png", dpi=300, width=5, height=8)

ggplot(sorted, aes(x=race, y=sampling_benefit_per_child_eligible)) +
  plot +
  geom_errorbar(
    data=sorted, 
    aes(
      x=race, 
      # y=dp_sampling_benefit_per_child,
      ymin=sampling_benefit_per_child_eligible, 
      ymax=dp_sampling_benefit_per_child_eligible,
      color=""
    ),
    size=0.5,
    width=0.5
  ) +
  ylab("Race-weighted misallocation per eligible child") +
  scale_fill_manual(values=c("#00BFC4")) +
  scale_colour_manual(values=c("black")) +
  labs(
    fill = "Data error",
    color = "+ DP error"
  ) +
  theme(
    legend.position = "top"
  ) +
  guides(
    fill = guide_legend(override.aes = list(color="transparent"))
  )
ggsave(sprintf("plots/race/misalloc_%s.png", kind), dpi=300, width=5, height=6)

# ggplot(comparison_all, aes(x=reorder(race, dp_sampling_benefit_per_child_eligible), y=dp_sampling_benefit_per_child_eligible)) +
#   plot +
#   ylab("Race-weighted misallocation (DP + sampling minus no true) per eligible child")
# ggsave("plots/misalloc_race_dp_sampling.png", dpi=300, width=5, height=8)

# misalloc_nonwhite = df$misalloc * (1-df$prop_white)
# misalloc_white = df$misalloc * df$prop_white
# t.test(misalloc_white, misalloc_nonwhite)
```


## Individual variable plots

```{r population}
income = ggplot(grouped, aes(x=log(true_pop_total), y=misalloc_per_child)) 
income + geom_point() +
  stat_cor(method="pearson") +
  xlab("Log population") +
  ylab("Misallocation per child")

income + geom_hex(bins=30)
```

```{r income}
income = ggplot(grouped, aes(x=median_income_est, y=misalloc_per_child)) 
income + geom_point() +
  stat_cor(method="pearson") +
  xlab("Median income") +
  ylab("Misallocation per child")
income + geom_hex(bins=30)
```

```{r language}
lang = ggplot(grouped, aes(x=language_other_than_english_language_spoken_at_home_pct/100, y=misalloc_per_child)) 
lang + geom_point() +
  stat_cor(method="pearson") +
  xlab("% language other than English spoken at home") +
  ylab("Misallocation per child")
lang + geom_hex(bins=30)
```

```{r foreign}
foreign = ggplot(grouped, aes(x=foreign_born_place_of_birth_pct/100, y=misalloc_per_child)) 
foreign + geom_point() +
  stat_cor(method="pearson")
foreign + geom_hex(bins=30)
```

```{r ctznshp}
ctznshp = ggplot(grouped, aes(x=not_a_u_s_citizen_u_s_citizenship_status_pct/100, y=misalloc_per_child)) 
ctznshp + geom_point() +
  stat_cor(method="pearson") +
  xlab("% not a U.S. citizen") +
  ylab("Misallocation per child")
ctznshp + geom_hex(bins=30)
```

```{r renters}
renters = ggplot(grouped, aes(x=renter_occupied_housing_tenure_pct/100, y=misalloc_per_child)) 
renters + geom_point() +
  stat_cor(method="pearson") +
  xlab("% renter-occupied housing") +
  ylab("Misallocation per child")
renters + geom_hex(bins=30)
```

```{r household_size}
household_size = ggplot(grouped, aes(x=average_household_size_of_renter_occupied_unit_housing_tenure_est, y=misalloc_per_child)) 
household_size + geom_point() +
  stat_cor(method="pearson")
household_size + geom_hex(bins=30)
```

```{r two-way}

grouped_extreme = grouped  %>%
  filter(
    misalloc > mean(misalloc_per_child) + 2*sd(misalloc_per_child) | misalloc_per_child < mean(misalloc_per_child) - 2*sd(misalloc_per_child)
  )

grouped_extreme$highlight = grouped_extreme$misalloc_per_child > mean(grouped_extreme$misalloc_per_child) + 2*sd(grouped_extreme$misalloc_per_child) |
  grouped_extreme$misalloc_per_child < mean(grouped_extreme$misalloc_per_child) - 2*sd(grouped_extreme$misalloc_per_child)

ggplot(grouped_extreme, aes(x=prop_white, y=log(true_pop_total), color=misalloc_per_child)) +
  geom_point(size=1) +
  geom_point(data=subset(grouped_extreme, highlight), mapping=aes(x=prop_white, y=log(true_pop_total), color=misalloc_per_child)) +
  scale_colour_gradient2()

ggplot(grouped_extreme, aes(x=median_income_est, y=log(true_pop_total), color=misalloc_per_child)) +
  geom_point(size=1) +
  geom_point(data=subset(grouped_extreme, highlight), mapping=aes(x=median_income_est, y=log(true_pop_total), color=misalloc_per_child)) +
  scale_colour_gradient2()

ggplot(grouped_extreme, aes(x=prop_white, y=foreign_born_place_of_birth_pct/100, color=misalloc_per_child)) +
  geom_point(size=1) +
  geom_point(data=subset(grouped_extreme, highlight), mapping=aes(x=prop_white, y=foreign_born_place_of_birth_pct/100, color=misalloc_per_child)) +
  scale_colour_gradient2()

ggplot(grouped_extreme, aes(x=language_other_than_english_language_spoken_at_home_pct, y=log(true_pop_total), color=misalloc_per_child)) +
  geom_point(size=1) +
  geom_point(data=subset(grouped_extreme, highlight), mapping=aes(x=language_other_than_english_language_spoken_at_home_pct, y=log(true_pop_total), color=misalloc_per_child)) +
  scale_colour_gradient2()
```
  



## Regression analysis
```{r regressions}
df_reg = clean_for_reg(df)
nrow(df_reg)
```

### OLS

```{r ols}
lm = lm(misalloc ~ white_race_pct + black_or_african_american_race_pct, data=df_abbrv)
lm_cov = lm(misalloc ~ white_race_pct + black_or_african_american_race_pct + true_children_total + true_children_poverty, data=filtered)
lm_cov2 = lm(
  misalloc ~ white_race_pct + black_or_african_american_race_pct + true_children_total + true_children_poverty +
      log(true_pop_total) +
      language_other_than_english_language_spoken_at_home_pct +
      foreign_born_place_of_birth_pct +
      not_a_u_s_citizen_u_s_citizenship_status_pct +
      renter_occupied_housing_tenure_pct +
      average_household_size_of_renter_occupied_unit_housing_tenure_est +
      median_income_est,
  data=df_abbrv
)
lm2 = lm(sqrt(misalloc^2) ~ white_race_pct + black_or_african_american_race_pct, data=df_abbrv)
lm2_cov = lm(sqrt(misalloc^2) ~ white_race_pct + black_or_african_american_race_pct + true_children_total + true_children_poverty, data=df_abbrv)
lm2_cov2 = lm(
  sqrt(misalloc^2) ~ white_race_pct + black_or_african_american_race_pct + true_children_total + true_children_poverty +
      log(true_pop_total) +
      language_other_than_english_language_spoken_at_home_pct +
      foreign_born_place_of_birth_pct +
      not_a_u_s_citizen_u_s_citizenship_status_pct +
      renter_occupied_housing_tenure_pct +
      average_household_size_of_renter_occupied_unit_housing_tenure_est +
      median_income_est, 
  data=df_abbrv
)

stargazer(
  lm, lm_cov, lm_cov2, lm2, lm2_cov, lm2_cov2,
  type="text",
  title="Correlation between covariates and DP-induced misallocation. Positive = more received under DP.",
  covariate.labels=c("Proportion White", "Proportion Black", "Proportion Asian", "Total # children", "Total # children in poverty", "Log population", "% language other than English spoken at home", "% foreign-born", "% not a U.S. citizen", "% Renters", "Avg. household size", "Median income"),
  label="discrimination",
  omit=c("trial", "district_id", "state_fips_code")
  # out="results/discrimination.tex"
)
```


### GAM
```{r gam-mr}
sampling_only = T
gam_mr = get_gam("baseline", sampling_only, F, df)
```


```{r gam-interact}
gam_mr_interact = gam(
  misalloc ~
      te(
        prop_white,
        hhi,
        median_income_est
      ) +
      s(true_children_total, bs="tp") +
      s(true_children_poverty, bs="tp") +
      s(log(true_pop_total), bs="tp") +
      s(prop_hispanic, bs="tp"),
      # ti(
      #   language_other_than_english_language_spoken_at_home_pct,
      #   foreign_born_place_of_birth_pct,
      #   not_a_u_s_citizen_u_s_citizenship_status_pct
      # ) +
      # ti(
      #   renter_occupied_housing_tenure_pct,
      #   average_household_size_of_renter_occupied_unit_housing_tenure_est
      # ),
  method="REML", # restricted MLE
  data=df_abbrv
)
summary(gam_mr_interact)
anova(gam_mr, gam_mr_interact)
```

```{r gam_viz}
# plot_smooths(
#   model=gam_fit,
#   series=prop_white
# )

# vis.gam(gam_mr, view=c("prop_white", "median_income_est"))

plot_gam(getViz(gam_mr), sprintf("baseline_sampling=%s", sampling_only))
```

### Inverse welfare
```{r welfare-weights}
# ordinal_logit = polr(
#   misalloc ~ prop_white +
#       true_children_total + 
#       true_children_poverty +
#       log(true_pop_total) +
#       median_income_est +
#       hhi +
#       prop_hispanic,
#       # language_other_than_english_language_spoken_at_home_pct +
#       # foreign_born_place_of_birth_pct +
#       # not_a_u_s_citizen_u_s_citizenship_status_pct +
#       # renter_occupied_housing_tenure_pct +
#       # average_household_size_of_renter_occupied_unit_housing_tenure_est +
#   data=df_abbrv,
#   Hess=TRUE
# )
```







## Treatment comparison
```{r treatments}
test_experiment = "hold_harmless"
experiment = load_experiment(test_experiment)
```

```{r treatment-plot}
plot_race(experiment, test_experiment, "hispanic")
```

```{r treatment-gam}
experiment_name = "hold_harmless"
for (t in unique(experiment$treatment)) {
  print(sprintf("%s: %s", experiment_name, t))
  gam_mr = get_gam(
    sprintf("%s_%s", experiment_name, t),
    F,
    from_cache,  # load gam from cache?
    experiment %>% filter(treatment == t)
  )
  plotname = sprintf("%s_%s", experiment_name, t)
  viz = get_gam_viz(
    plotname,
    from_cache,  # load viz from cache?
    gam_mr
  )
  plot_gam(viz, plotname)
}
```

```{r plot-all, warning=FALSE}
trials = 100

for (experiment_name in c(
  # "hold_harmless",
  # "post_processing",
  # "thresholds",
  # "moving_average",
  # "moving_average_truth=unmodified",
  # "moving_average_truth=average",
  # "epsilon",
  "budget"
)) {
  rm(experiment)

  print(experiment_name)
  experiment = load_experiment(experiment_name)
  print(nrow(experiment))
  
  # reduced size for GAM - otherwise takes too long... maybe reverse this later
  experiment = experiment %>% filter(trial < trials)
  
  plot_race(experiment, experiment_name, "race_aggregate", 2)
  
  # from_cache = T
  # 
  # for (t in unique(experiment$treatment)) {
  #   print(sprintf("%s: %s", experiment_name, t))
  #   gam_mr = get_gam(
  #     sprintf("%s_%s", experiment_name, t),
  #     F,
  #     from_cache,  # load gam from cache?
  #     experiment %>% filter(treatment == t)
  #   )
  #   plotname = sprintf("%s_%s", experiment_name, t)
  #   viz = get_gam_viz(
  #     plotname,
  #     from_cache,  # load viz from cache?
  #     gam_mr
  #   )
  #   plot_gam(viz, plotname)
  # }
}
```

