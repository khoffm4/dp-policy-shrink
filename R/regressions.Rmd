---
title: "Regression Analysis"
author: "Ryan Steed"
date: "9/9/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r deps}
library(stargazer)
library(tidyverse)
library(janitor)
```

```{r load}
raw = read.csv("results/discrimination.csv")
raw
```
```{r clean}
# use short df
# df = raw %>% filter(trial < 10)
df = raw %>%
  clean_names() %>%
  mutate_at(
    vars(matches("race_pct$")), list(`children`= ~(. / 100 * true_children_total))
  ) 
df
df = df %>%
  mutate(
    prop_white = white_race_pct / 100,
    nonwhite_children = true_children_total * prop_white,
    # misalloc in terms of true grant total - TODO make sure this matches, normalize before this
    misalloc = est_grant_total - true_grant_total
  )
df
```

## Costs & benefits across groups
```{r average_across_trials}
grouped = df %>% 
  group_by(state_fips_code, district_id) %>%
  summarise(misalloc = mean(misalloc)) %>%
  ungroup() %>%
  left_join(
    df %>% select(
      state_fips_code, 
      district_id, 
      nonwhite_children,
      true_children_eligible,
      true_children_total, 
      prop_white,
      ends_with("race_pct_children")
    ) %>% unique(),
    by=c("state_fips_code", "district_id")
  )
grouped
```

```{r dist}
# misalloc per non-white student
ggplot(grouped, aes(x=nonwhite_children, y=misalloc)) +
  geom_point()

# average misalloc per student
ggplot(grouped, aes(x=misalloc / true_children_total)) +
  geom_histogram(bins=100)
# average misalloc per eligible student
ggplot(df, aes(x=misalloc / true_children_total)) +
  geom_histogram(bins=100)

# total misalloc per student ("burden")
comparison = grouped %>%
  pivot_longer(
    ends_with("race_pct_children"),
    values_to="children_of_race",
    names_to="race"
  ) %>%
  mutate(
    race=str_replace(race, "_race_pct_children", "")
  ) %>%
  # assuming misallocation is spread evenly across children,
  mutate(benefit_per_child = misalloc * children_of_race / true_children_total)


comparison_all = comparison %>%
  group_by(race) %>%
  mutate(
    race_avg_benefit_per_child = mean(benefit_per_child)
  )  %>%
  ungroup()

grid = ggplot(comparison_all, aes(x=log(benefit_per_child-min(benefit_per_child)))) +
  geom_histogram(bins=100) +
  facet_wrap(~race, ncol=3, scales="free_y")

comparison_mean = comparison %>%
  group_by(race) %>% 
  summarise(
    avg_benefit_per_child = log(mean(benefit_per_child-min(benefit_per_child)-min(benefit_per_child))),
    med_benefit_per_child = median(log(benefit_per_child-min(benefit_per_child)), na.rm=TRUE)
  ) %>%
  ungroup()

grid + 
  geom_vline(aes(xintercept=avg_benefit_per_child), comparison_mean, color="red") +
  geom_vline(aes(xintercept=med_benefit_per_child), comparison_mean, color="blue")

ggplot(comparison_all, aes(x=reorder(race, race_avg_benefit_per_child), y=log(benefit_per_child-min(benefit_per_child)))) +
  geom_boxplot(notch=TRUE) +
  coord_flip()

ggplot(comparison_mean, aes(x=reorder(race, avg_benefit_per_child), y=avg_benefit_per_child)) +
  geom_col() +
  coord_flip()


# misalloc_nonwhite = df$misalloc * (1-df$prop_white)
# misalloc_white = df$misalloc * df$prop_white
# t.test(misalloc_white, misalloc_nonwhite)
```
  
## Effect of race on misallocations
### OLS

```{r ols}
lm = lm(misalloc ~ prop_white, data=df)
lm_cov = lm(misalloc ~ prop_white + true_pop_total + true_children_total + true_children_poverty  + factor(trial), data=df)
lm2 = lm(sqrt(misalloc^2) ~ prop_white, data=df)
lm2_cov = lm(sqrt(misalloc^2) ~ prop_white + true_pop_total + true_children_total + true_children_poverty  + factor(trial), data=df)

stargazer(
  lm, lm_cov, lm2, lm2_cov,
  type="text",
  title="Correlation between race and noise-induced error.",
  covariate.labels=c("Proportion white-only individuals", "Total pop", "Total children", "Total children in poverty"),
  label="discrimination",
  omit=c("trial", "district_id", "state_fips_code")
  # out="results/discrimination.tex"
)
```

## Traditional discrimination analysis
```{r diff}
lm = lm(est_grant_total ~ true_grant_total + prop_white + trial + district_id + state_fips_code, data=df)

stargazer(
  lm,
  type="text",
  title="Correlation between race and estimated grant amount.",
  covariate.labels=c("True grant total", "Proportion white-only individuals"),
  label="discrimination"
  # out="results/discrimination.tex"
)
```

