---
title: "Regression Analysis"
author: "Ryan Steed"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r deps}
source("R/utils.R")
```

## Regression analysis
```{r regressions}
regression_tables("baseline", F, 10)
```


## Treatment comparison
```{r treatments}
test_experiment = "hold_harmless"
experiment = load_experiment(test_experiment, 10)
```

```{r}
df_reg = clean_for_reg(experiment, F) %>% filter(treatment == "Hold harmless")
```

```{r}
gam_mr = gam(
    misalloc ~
      # s(true_children_total, bs="tp") +
      # s(true_children_poverty, bs="tp") +
      s(log(pop_density), bs="tp") +
      s(hhi, bs="tp") +
      s(prop_white, bs="tp") +
      s(prop_hispanic, bs="tp") +
      s(median_income_est, bs="tp") +
      # s(not_a_u_s_citizen_u_s_citizenship_status_pct, bs="tp") +
      s(renter_occupied_housing_tenure_pct, bs="tp"),
    # s(average_household_size_of_renter_occupied_unit_housing_tenure_est, bs="tp"),
    method="REML", # restricted MLE
    data=df_reg
  )
summary(gam_mr)
```

```{r}
gam_mr_interact = gam(
    misalloc ~
      te(
        prop_white,
        log(pop_density)
      ) +
      s(median_income_est, bs="tp") +
      s(hhi, bs="tp") +
      s(prop_hispanic, bs="tp") +
      s(renter_occupied_housing_tenure_pct, bs="tp"),
    data=df_reg
  )
summary(gam_mr_interact)
stargazer(anova.gam(gam_mr, gam_mr_interact, test="F"), type="text", summary=FALSE)
b = getViz(gam_mr_interact)
```
```{r}
plot(sm(b, 1)) +
  theme_minimal() +
  l_fitRaster(pTrans = function(p) p < 0.05) +
  l_fitContour() +
  l_points(alpha=0.2) +
  scale_fill_distiller(type="div", direction=1) +
  guides(
    fill=guide_legend(title="Smoothed effect ($ misallocated)")
  ) +
  labs(
    title = element_blank(),
    # x = "% white-only",
    # y = "Median income"
  )
```


```{r treatment-gam}
experiment_name = "hold_harmless"
for (t in unique(experiment$treatment)) {
  print(sprintf("%s: %s", experiment_name, t))
  gam_mr = get_gam(
    sprintf("%s_%s", experiment_name, t),
    F,
    from_cache,  # load gam from cache?
    experiment %>% filter(treatment == t)
  )
  plotname = sprintf("%s_%s", experiment_name, t)
  viz = get_gam_viz(
    plotname,
    from_cache,  # load viz from cache?
    gam_mr
  )
  plot_gam(viz, plotname)
}
```

```{r plot-all, warning=FALSE}
source("R/plot_all.R")
```

